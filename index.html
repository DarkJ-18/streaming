function checkoutWhatsApp() {
    if (cart.length === 0) {
        showToast("Tu carrito est√° vac√≠o. Agrega productos antes de pedir.", "error");
        return;
    }

    try {
        // 1. Construcci√≥n del Payload en Texto Plano (Cero Precios)
        let rawMessage = "üü¢ *NUEVA SOLICITUD DE PEDIDO* üü¢\n";
        rawMessage += "-----------------------------------\n";
        
        cart.forEach((item, index) => {
            rawMessage += `*${index + 1}. ${item.name}*\n`;
            if(item.details) rawMessage += `   ‚Ü≥ Detalles: _${item.details}_\n`;
            rawMessage += `\n`; // Espaciado
        });

        rawMessage += "-----------------------------------\n";
        rawMessage += "Por favor, conf√≠rmenme la disponibilidad y el precio total a pagar.\n\n";

        // ID de Rastreo para que tu agente no pierda el hilo
        const sessionRef = new Date().toISOString().replace(/[-:.]/g, "").slice(0, 14);
        rawMessage += `_Ref: WEB-${sessionRef}_`;

        // 2. Serializaci√≥n Criptogr√°ficamente Segura de la URL
        // Esto garantiza que caracteres como +, &, % o emojis no rompan el Deep Link
        const encodedPayload = encodeURIComponent(rawMessage);
        
        // 3. Ejecuci√≥n del Handoff
        const TARGET_PHONE = "573132973032"; 
        window.open(`https://wa.me/${TARGET_PHONE}?text=${encodedPayload}`, '_blank', 'noopener,noreferrer');

        // 4. Mutaci√≥n de Estado (Purga del Carrito)
        // Evita que el cliente regrese a la web y env√≠e el pedido dos veces por error
        cart = [];
        updateCartUI();
        toggleCart(); // Cierra el panel lateral
        showToast("Redirigiendo a WhatsApp...", "info");
        
    } catch (error) {
        console.error("Error en Handoff:", error);
        showToast("Error cr√≠tico al generar el enlace de red", "error");
    }
}