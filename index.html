<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tienda Streaming | Catálogo & Pedidos</title>
    <!-- Font Awesome para iconos vectoriales (Estabilidad Cross-Platform) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ========================================
        ARQUITECTURA CSS: MATHEMATICAL FLUIDITY
        ========================================
        */
        :root {
            --bg-void: #0a0b10;
            --bg-panel: #14161f;
            --bg-input: #1c1f2b;
            --text-primary: #e0e6ed;
            --text-secondary: #94a3b8;
            --accent-primary: #3b82f6; 
            --accent-success: #10b981;
            --accent-warning: #f59e0b;
            --accent-danger: #ef4444;
            --accent-purple: #8b5cf6; 
            --accent-gold: #fbbf24; 
            --border-subtle: rgba(255, 255, 255, 0.08);
            
            --space-s: clamp(0.75rem, 0.5rem + 0.5vw, 1rem);
            --space-m: clamp(1.5rem, 1rem + 1vw, 2.5rem);
            
            --font-body: clamp(1rem, 0.9rem + 0.3vw, 1.125rem);
            --radius-std: 0.75rem;
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            background-color: var(--bg-void);
            color: var(--text-primary);
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            font-size: var(--font-body);
            line-height: 1.6;
            padding-bottom: 100px; /* Espacio para scroll final */
        }

        .layout-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--space-m);
        }

        header {
            text-align: center;
            border-bottom: 1px solid var(--border-subtle);
            padding-bottom: var(--space-m);
            margin-bottom: var(--space-m);
        }

        h1 {
            font-weight: 800;
            letter-spacing: -0.05em;
            background: linear-gradient(to right, #fff, #94a3b8);
            -webkit-background-clip: text;
            color: transparent;
        }

        /* GRID SYSTEM */
        .grid-matrix {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(clamp(260px, 20vw, 350px), 1fr));
            gap: 1.5rem;
            align-items: start;
            margin-bottom: 4rem;
        }

        .card-product {
            background: var(--bg-panel);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-std);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            position: relative;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            height: 100%;
        }
        
        .card-product:hover {
            border-color: var(--accent-primary);
            transform: translateY(-4px);
        }

        .card-product.iptv-card:hover {
            border-color: var(--accent-purple);
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.15);
        }

        .card-product.featured-card {
            border: 1px solid var(--accent-gold);
            background: linear-gradient(160deg, #1f1a0b 0%, #14161f 100%);
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.1);
        }
        
        .card-product.featured-card:hover {
            box-shadow: 0 0 30px rgba(251, 191, 36, 0.25);
            transform: scale(1.02);
        }

        .card-header {
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-subtle);
        }

        .product-title { font-weight: 700; color: white; line-height: 1.2; }
        .product-subtitle { font-size: 0.85em; color: var(--text-secondary); display: block; margin-top: 0.25rem; }
        
        .product-price {
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent-success);
            font-weight: 700;
            font-size: 1.4em;
            margin-top: 0.5rem;
        }
        
        .featured-card .product-price {
            color: var(--accent-gold);
            text-shadow: 0 0 10px rgba(251, 191, 36, 0.3);
        }

        .badge {
            font-size: 0.7rem;
            padding: 0.2em 0.5em;
            border-radius: 4px;
            background: rgba(255,255,255,0.1);
            color: var(--text-primary);
            text-transform: uppercase;
            margin-left: 0.5em;
        }
        .badge-iptv { background: rgba(139, 92, 246, 0.2); color: #a78bfa; }
        .badge-star { background: var(--accent-gold); color: #000; font-weight: 800; margin-bottom: 0.5rem; display: inline-block; margin-left: 0; }

        /* BOTÓN AGREGAR (En Tarjetas) */
        .btn-add-cart {
            margin-top: 1rem;
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-subtle);
            background: var(--bg-input);
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-add-cart:hover {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
        }

        .iptv-card .btn-add-cart:hover {
            background: var(--accent-purple);
            border-color: var(--accent-purple);
        }

        /* CONTROL DE MONEDA */
        .currency-control {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 2rem;
        }

        .currency-btn {
            background: var(--bg-input);
            border: 1px solid var(--border-subtle);
            color: var(--text-secondary);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .currency-btn i {
            font-size: 1.1em;
        }

        .currency-btn.active {
            background: var(--accent-purple);
            color: white;
            border-color: var(--accent-purple);
            box-shadow: 0 0 10px rgba(139, 92, 246, 0.4);
        }

        /* COMBO BUILDER */
        .combo-builder {
            grid-column: 1 / -1;
            background: linear-gradient(160deg, #14161f 0%, #0f1118 100%);
            border: 1px solid var(--border-subtle);
            padding: 0;
            overflow: hidden;
            border-radius: var(--radius-std);
        }

        .combo-controls {
            padding: 2rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }

        .combo-base-selector {
            grid-column: 1 / -1;
            display: flex;
            gap: 1rem;
            overflow-x: auto;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-subtle);
            margin-bottom: 1rem;
        }

        .selector-btn {
            background: var(--bg-input);
            border: 1px solid var(--border-subtle);
            color: var(--text-secondary);
            padding: 1rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            white-space: nowrap;
            font-weight: 600;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .selector-btn.active {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        .input-hidden { position: absolute; opacity: 0; width: 0; height: 0; }

        .platform-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 0.75rem;
        }

        .check-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1rem;
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s;
            text-align: center;
            height: 100%;
            user-select: none;
        }

        .input-hidden:checked + .check-btn {
            background: rgba(16, 185, 129, 0.15);
            border-color: var(--accent-success);
            color: var(--accent-success);
            font-weight: 600;
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.1);
        }

        .input-hidden:disabled + .check-btn {
            opacity: 0.25;
            cursor: not-allowed;
            background: transparent;
            border-color: transparent;
            color: rgba(255,255,255,0.2);
        }

        .tier-list { display: flex; flex-direction: column; gap: 0.5rem; }

        .tier-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            background: var(--bg-input);
            cursor: pointer;
            transition: all 0.2s;
        }

        .input-hidden:checked + .tier-row {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
        }

        .result-bar {
            background: #000;
            padding: 1.5rem 2rem;
            border-top: 1px solid var(--border-subtle);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .btn-combo-add {
            background: var(--accent-success);
            color: #000;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-combo-add:hover { transform: scale(1.05); box-shadow: 0 0 15px rgba(16, 185, 129, 0.4); }
        .btn-combo-add:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; filter: grayscale(1); }

        .section-title {
            grid-column: 1 / -1;
            color: var(--accent-primary);
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border-subtle);
            padding-bottom: 0.5rem;
        }

        /* ============================
           TOAST NOTIFICATIONS (ENHANCED)
           ============================ */
        .toast-container {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            pointer-events: none;
        }

        .toast {
            background: rgba(20, 22, 31, 0.95);
            border: 1px solid var(--accent-success);
            border-left: 4px solid var(--accent-success);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            min-width: 300px;
            animation: toastSlideUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            backdrop-filter: blur(10px);
        }

        /* Estilo para Errores */
        .toast.error {
            border-color: var(--accent-danger);
            border-left-color: var(--accent-danger);
        }
        
        .toast.error i { color: var(--accent-danger); }
        .toast.success i { color: var(--accent-success); }

        .toast i { font-size: 1.2rem; }

        @keyframes toastSlideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes toastFadeOut {
            to { opacity: 0; transform: translateY(-10px); }
        }

        /* ============================
           CARRITO FLOTANTE (CART UI)
           ============================ */
        .cart-float-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--accent-success);
            color: #000;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            z-index: 1000;
            transition: transform 0.2s;
        }

        .cart-float-btn:hover { transform: scale(1.1); }

        .cart-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--accent-danger);
            color: white;
            font-size: 0.75rem;
            font-weight: bold;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--bg-void);
        }

        .cart-sidebar {
            position: fixed;
            top: 0;
            right: -400px;
            width: 100%;
            max-width: 400px;
            height: 100vh;
            background: #0f1118;
            border-left: 1px solid var(--border-subtle);
            z-index: 1001;
            transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            box-shadow: -10px 0 30px rgba(0,0,0,0.8);
        }

        .cart-sidebar.open { right: 0; }

        .cart-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-panel);
        }

        .cart-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .cart-items {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .item-info { flex-grow: 1; margin-right: 1rem; }
        .item-name { font-weight: 600; color: white; display: block; font-size: 0.95em; }
        .item-meta { font-size: 0.8em; color: var(--text-secondary); display: block; }
        .item-price { font-family: monospace; color: var(--accent-success); font-weight: 700; }
        
        .btn-remove {
            background: none;
            border: none;
            color: var(--accent-danger);
            cursor: pointer;
            opacity: 0.6;
            padding: 0 0.5rem;
        }
        .btn-remove:hover { opacity: 1; }

        .cart-footer {
            padding: 1.5rem;
            border-top: 1px solid var(--border-subtle);
            background: var(--bg-panel);
        }

        .cart-total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
            font-size: 1.1em;
            font-weight: 700;
            color: white;
        }

        .btn-checkout {
            width: 100%;
            padding: 1rem;
            background: #25D366; /* WhatsApp Green */
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            transition: background 0.2s;
        }

        .btn-checkout:hover { background: #20bd5a; }

        .overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            backdrop-filter: blur(2px);
        }
        .overlay.open { opacity: 1; pointer-events: all; }

    </style>
</head>
<body>

    <main class="layout-container">
        <header>
            <h1>Tienda Streaming</h1>
            <p>Selecciona tus servicios y crea tu pedido</p>
        </header>

        <!-- 1. INVENTARIO PREMIUM -->
        <h2 class="section-title">Plataformas Premium</h2>
        <section class="grid-matrix" id="premium-grid"></section>

        <!-- 2. INVENTARIO ESTÁNDAR -->
        <h2 class="section-title">Plataformas Estándar</h2>
        <section class="grid-matrix" id="standard-grid"></section>
        
        <!-- 3. SECCIÓN IPTV (CON SWITCH DE MONEDA REPARADO) -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 4rem; margin-bottom: 1rem; border-bottom: 1px solid var(--border-subtle); padding-bottom: 0.5rem;">
            <h2 class="section-title" style="color: var(--accent-purple); margin: 0; border: none;">Televisión Digital (IPTV)</h2>
            
            <div class="currency-control">
                <button class="currency-btn active" id="btn-cop" onclick="setIPTVCurrency('COP')">
                    <i class="fas fa-coins"></i> COP
                </button>
                <button class="currency-btn" id="btn-usd" onclick="setIPTVCurrency('USD')">
                    <i class="fas fa-dollar-sign"></i> USD
                </button>
            </div>
        </div>
        
        <section class="grid-matrix" id="iptv-grid"></section>

        <!-- 4. HERRAMIENTAS -->
        <h2 class="section-title" style="margin-top: 4rem;">Música & Utilidades</h2>
        <section class="grid-matrix" id="tools-grid"></section>

        <!-- 5. MOTOR DE COMBOS -->
        <h2 class="section-title">Arma tu Combo</h2>
        <article class="combo-builder">
            <div class="combo-controls">
                
                <!-- A. SELECCIÓN DE BASE -->
                <div style="grid-column: 1 / -1;">
                    <label style="display:block; margin-bottom:0.5rem; color:var(--text-secondary); font-size:0.85em; text-transform:uppercase; letter-spacing:0.05em;">1. Tipo de Combo</label>
                    <div class="combo-base-selector" id="base-selector"></div>
                </div>

                <!-- B. SELECCIÓN DE TAMAÑO -->
                <div>
                    <label style="display:block; margin-bottom:1rem; color:white; font-weight:600;">2. Cantidad de Pantallas</label>
                    <div id="size-options" class="tier-list"></div>
                </div>

                <!-- C. SELECCIÓN DE ADICIONALES -->
                <div>
                    <label style="display:block; margin-bottom:1rem; color:white; font-weight:600;">
                        3. Elige tus Servicios (<span id="count-current">0</span>/<span id="count-max">--</span>)
                    </label>
                    <div id="platform-options" class="platform-grid"></div>
                    <p style="font-size:0.8em; color:var(--accent-warning); margin-top:0.75rem; line-height:1.4;" id="combo-note"></p>
                </div>
            </div>

            <div class="result-bar">
                <div>
                    <div style="font-size:0.85em; color:var(--text-secondary);">BASE: <span id="base-includes" style="color:white; font-weight:600;">--</span></div>
                </div>
                <div style="display:flex; align-items:center; gap:1.5rem;">
                    <div class="product-price" id="total-price" style="margin:0;">$0 COP</div>
                    <button class="btn-combo-add" id="btn-add-combo" onclick="addComboToCart()">
                        <i class="fas fa-cart-plus"></i> Agregar
                    </button>
                </div>
            </div>
        </article>

    </main>

    <!-- UI DEL CARRITO -->
    <button class="cart-float-btn" onclick="toggleCart()">
        <i class="fas fa-shopping-cart"></i>
        <div class="cart-badge" id="cart-count">0</div>
    </button>

    <div class="overlay" id="cart-overlay" onclick="toggleCart()"></div>

    <aside class="cart-sidebar" id="cart-sidebar">
        <div class="cart-header">
            <h3 style="color:white; margin:0;">Tu Pedido</h3>
            <button class="cart-close" onclick="toggleCart()">&times;</button>
        </div>
        <div class="cart-items" id="cart-items-container">
            <!-- Items renderizados por JS -->
            <div style="text-align:center; color:var(--text-secondary); margin-top:2rem;">
                Tu carrito está vacío.
            </div>
        </div>
        <div class="cart-footer">
            <div class="cart-total-row">
                <span>Total Estimado:</span>
                <span id="cart-total-display">$0</span>
            </div>
            <button class="btn-checkout" onclick="checkoutWhatsApp()">
                <i class="fab fa-whatsapp"></i> Enviar Pedido
            </button>
        </div>
    </aside>

    <!-- CONTENEDOR DE NOTIFICACIONES (TOASTS) -->
    <div class="toast-container" id="toast-container"></div>

    <script>
        // --- CONFIGURACIÓN & ESTADO ---
        const FORMATTER_COP = new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 });
        const FORMATTER_USD = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2 });
        
        let currentIPTVCurrency = 'COP';
        
        // Estado del Carrito: Array de objetos { name, details, price, currency }
        let cart = [];

        /* * INVENTARIO v2.7 */
        const INVENTORY = {
            premium: [
                { id: "nfx", name: "Netflix Premium 4K", sub: "Cuenta Original", price: 15000 },
                { id: "dsp", name: "Disney Premium", sub: "Incluye ESPN", price: 16000 },
                { id: "max", name: "Max", sub: "Cuenta Original", price: 14000 },
                { id: "amz", name: "Amazon Prime Video", sub: "Sin Publicidad", price: 15000 },
                { id: "uni", name: "Universal+", sub: "Series NBC", price: 14000 }
            ],
            standard: [
                { id: "cru", name: "CrunchyRoll", sub: "Fan", price: 14000 },
                { id: "par", name: "Paramount+", sub: "Standard", price: 14000 },
                { id: "plx", name: "Plex", sub: "Activación", price: 15000 },
                { id: "dss", name: "Disney Standard", sub: "Básico", price: 12000 },
                { id: "vix", name: "ViX Premium", sub: "Deportes", price: 12000 }
            ],
            iptv: [
                { id: "ip1m1", name: "IPTV 1 Mes", sub: "1 Pantalla", price: 13000, priceUsd: 6.00 },
                { id: "ip1m4", name: "IPTV 1 Mes", sub: "4 Dispositivos", price: 18000, priceUsd: 9.00 },
                { id: "ip2m4", name: "IPTV 2 Meses", sub: "4 Dispositivos", price: 35000, priceUsd: 16.00 },
                { id: "ip3m4", name: "Pack Trimestral (3x2)", sub: "4 Disp (Pague 2 Lleve 3)", price: 50000, priceUsd: 22.00, featured: true },
                { id: "ip6m4", name: "IPTV 6 Meses", sub: "4 Dispositivos", price: 90000, priceUsd: 40.00 },
                { id: "ip1y4", name: "IPTV 1 Año", sub: "4 Dispositivos", price: 165000, priceUsd: 70.00 },
                { id: "mega", name: "Mega TV", sub: "1 Mes", price: 27000, priceUsd: 12.00, localOnly: true },
                { id: "jelly", name: "Jellyfin", sub: "1 Mes", price: 22000, priceUsd: 10.00, localOnly: true }
            ],
            tools: [
                { id: "yt1", name: "YouTube Premium", sub: "1 Mes", price: 16000 },
                { id: "yt3", name: "YouTube Premium", sub: "3 Meses", price: 39000 },
                { id: "spo", name: "Spotify Premium", sub: "3 Meses", price: 39000 },
                { id: "gpt", name: "ChatGPT Plus", sub: "Cuenta Personal", price: 28000 },
                { id: "cnv", name: "Canva Pro", sub: "1 Año", price: 110000 }
            ]
        };

        const COMBO_SYSTEM = {
            "god_tier": {
                label: "PACK SUPREMO (NFLX + DISNEY)",
                includes: "Netflix 4K + Disney Premium",
                note: "Selecciona adicionales distintos.",
                options: ["Max", "Amazon Prime", "Universal+", "IPTV", "ViX", "Plex", "CrunchyRoll", "Paramount"],
                tiers: [ 
                    { k: 2, label: "Solo Base", retail: 30000 },
                    { k: 3, label: "Tripleta (+1 Adicional)", retail: 37000 },
                    { k: 4, label: "Cuadrupleta (+2 Adicionales)", retail: 46000 },
                    { k: 5, label: "Quintupla (+3 Adicionales)", retail: 53000 }
                ]
            },
            "netflix_4k": {
                label: "COMBO NETFLIX 4K",
                includes: "Netflix 4K",
                note: "Incluye Netflix. Agrega otras apps.",
                options: ["Max", "Amazon Prime", "Disney Standard", "Universal+", "IPTV", "ViX", "Plex", "CrunchyRoll", "Paramount"],
                tiers: [ 
                    { k: 2, label: "Dupla (+1 Adicional)", retail: 26000 },
                    { k: 3, label: "Tripleta (+2 Adicionales)", retail: 33000 },
                    { k: 4, label: "Cuadrupleta (+3 Adicionales)", retail: 40000 },
                    { k: 5, label: "Quintupla (+4 Adicionales)", retail: 47000 }
                ]
            },
            "disney_prem": {
                label: "COMBO DISNEY PREMIUM",
                includes: "Disney Premium (ESPN)",
                note: "Incluye Disney+. Agrega otras apps.",
                options: ["Max", "Amazon Prime", "Universal+", "IPTV", "ViX", "Plex", "CrunchyRoll", "Paramount"],
                tiers: [ 
                    { k: 2, label: "Dupla (+1 Adicional)", retail: 25000 },
                    { k: 3, label: "Tripleta (+2 Adicionales)", retail: 31000 },
                    { k: 4, label: "Cuadrupleta (+3 Adicionales)", retail: 37000 },
                    { k: 5, label: "Quintupla (+4 Adicionales)", retail: 45000 }
                ]
            },
            "flex_mix": {
                label: "COMBOS VARIOS",
                includes: "Selección Libre",
                note: "Elige plataformas distintas.",
                options: ["Max", "Amazon Prime", "Disney Standard", "Universal+", "IPTV", "ViX", "Plex", "CrunchyRoll", "Paramount"],
                tiers: [ 
                    { k: 2, label: "Dupla (2 Pantallas)", retail: 19000 },
                    { k: 3, label: "Tripleta (3 Pantallas)", retail: 25000 },
                    { k: 4, label: "Cuadrupleta (4 Pantallas)", retail: 29000 },
                    { k: 5, label: "Quintupla (5 Pantallas)", retail: 33000 }
                ]
            }
        };

        // --- SISTEMA DE TOASTS (NOTIFICACIONES) ---
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            let iconClass = 'fa-check-circle';
            if(type === 'error') iconClass = 'fa-exclamation-circle';
            if(type === 'info') iconClass = 'fa-info-circle';

            toast.className = `toast ${type}`;
            toast.innerHTML = `<i class="fas ${iconClass}"></i> <span>${message}</span>`;
            
            container.appendChild(toast);
            
            // Eliminar después de 3 segundos
            setTimeout(() => {
                toast.style.animation = 'toastFadeOut 0.3s forwards';
                toast.addEventListener('animationend', () => {
                    toast.remove();
                });
            }, 3000);
        }

        // --- LÓGICA DEL CARRITO ---

        function toggleCart() {
            document.getElementById('cart-sidebar').classList.toggle('open');
            document.getElementById('cart-overlay').classList.toggle('open');
        }

        function addToCart(item, type = 'single') {
            try {
                // Validación de Moneda Mixta
                if (cart.length > 0 && cart[0].currency !== item.currency) {
                    showToast(`No puedes mezclar monedas (${cart[0].currency} y ${item.currency}). Finaliza tu pedido actual o vacía el carrito.`, 'error');
                    return;
                }

                // Clonar item para evitar referencias
                const cartItem = {
                    id: Date.now(), // ID único para el carrito
                    name: item.name,
                    details: item.sub || '',
                    price: item.price, // Valor numérico
                    currency: item.currency || 'COP'
                };
                
                cart.push(cartItem);
                updateCartUI();
                
                // Mostrar Toast
                showToast(`${item.name} agregado al carrito`, 'success');
            } catch (error) {
                console.error("Error al agregar al carrito:", error);
                showToast("Ocurrió un error al agregar el producto", "error");
            }
        }

        function addComboToCart() {
            try {
                // Validación de Moneda Mixta (Combos son siempre COP)
                if (cart.length > 0 && cart[0].currency !== 'COP') {
                    showToast("No puedes mezclar Combos (COP) con productos en USD. Finaliza tu pedido actual o vacía el carrito.", "error");
                    return;
                }

                // Extraer estado actual del combo
                const config = COMBO_SYSTEM[currentComboKey];
                const tierInput = document.querySelector('input[name="tier"]:checked');
                
                if(!tierInput) {
                    showToast("Por favor selecciona un tamaño para el combo.", "error");
                    return;
                }
                
                const tier = config.tiers[tierInput.value];
                
                // Obtener opciones seleccionadas
                const checkboxes = document.querySelectorAll('input[name="opt"]:checked');
                const selectedOpts = Array.from(checkboxes).map(cb => cb.value);
                
                const cartItem = {
                    id: Date.now(),
                    name: config.label,
                    details: `${tier.label} [${selectedOpts.join(', ')}]`,
                    price: tier.retail,
                    currency: 'COP' // Combos siempre en COP por ahora
                };

                cart.push(cartItem);
                updateCartUI();
                
                // Mostrar Toast
                showToast(`Combo ${config.label} agregado`, 'success');
            } catch (error) {
                console.error("Error en combo:", error);
                showToast("Error al procesar el combo", "error");
            }
        }

        function removeFromCart(id) {
            cart = cart.filter(item => item.id !== id);
            updateCartUI();
        }

        function updateCartUI() {
            // 1. Contador
            document.getElementById('cart-count').textContent = cart.length;

            // 2. Render List
            const container = document.getElementById('cart-items-container');
            if (cart.length === 0) {
                container.innerHTML = '<div style="text-align:center; color:var(--text-secondary); margin-top:2rem;">Tu carrito está vacío.</div>';
                document.getElementById('cart-total-display').textContent = '$0';
                return;
            }

            let html = '';
            let totalCOP = 0;
            let totalUSD = 0;

            cart.forEach(item => {
                const formattedPrice = item.currency === 'USD' 
                    ? FORMATTER_USD.format(item.price) 
                    : FORMATTER_COP.format(item.price);
                
                if(item.currency === 'USD') totalUSD += item.price;
                else totalCOP += item.price;

                html += `
                <div class="cart-item">
                    <div class="item-info">
                        <span class="item-name">${item.name}</span>
                        <span class="item-meta">${item.details}</span>
                    </div>
                    <div style="text-align:right;">
                        <div class="item-price">${formattedPrice}</div>
                        <button class="btn-remove" onclick="removeFromCart(${item.id})">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
                `;
            });

            container.innerHTML = html;

            // 3. Totales (Moneda Única Garantizada)
            let totalText = '';
            if (totalCOP > 0) totalText = FORMATTER_COP.format(totalCOP);
            else if (totalUSD > 0) totalText = FORMATTER_USD.format(totalUSD);
            
            document.getElementById('cart-total-display').textContent = totalText;
        }

        function checkoutWhatsApp() {
            if (cart.length === 0) {
                showToast("Tu carrito está vacío. Agrega productos antes de pedir.", "error");
                return;
            }

            try {
                let message = "Hola, me interesa realizar el siguiente pedido:%0A%0A";
                
                cart.forEach((item, index) => {
                    const price = item.currency === 'USD' ? `${item.price} USD` : `$${item.price}`;
                    message += `*${index + 1}. ${item.name}* (${price})%0A`;
                    if(item.details) message += `   ↳ ${item.details}%0A`;
                });

                const total = document.getElementById('cart-total-display').textContent;
                message += `%0A*TOTAL ESTIMADO: ${total}*`;
                
                // Reemplaza XXXXXXXXXX con tu número real
                window.open(`https://wa.me/573132973032?text=${message}`, '_blank');
            } catch (error) {
                console.error("Error checkout:", error);
                showToast("Error al generar enlace de WhatsApp", "error");
            }
        }

        // --- RENDERIZADO GRID (Modificado para Carrito) ---

        function renderGrid(id, data, style = 'normal') {
            const el = document.getElementById(id);
            if(!el) return;

            let displayPrice, displayFormatter, currencyCode;
            const isIptvSection = style === 'iptv';

            const filteredData = data.filter(item => {
                if (isIptvSection && currentIPTVCurrency === 'USD' && item.localOnly) return false;
                return true;
            });

            el.innerHTML = filteredData.map(item => {
                // Lógica de precio y moneda
                if (isIptvSection && currentIPTVCurrency === 'USD' && item.priceUsd) {
                    displayPrice = item.priceUsd;
                    displayFormatter = FORMATTER_USD;
                    currencyCode = 'USD';
                } else {
                    displayPrice = item.price;
                    displayFormatter = FORMATTER_COP;
                    currencyCode = 'COP';
                }

                // Preparamos objeto para el carrito (stringify para pasar al onclick)
                const itemPayload = JSON.stringify({
                    name: item.name,
                    sub: item.sub,
                    price: displayPrice,
                    currency: currencyCode
                }).replace(/"/g, "&quot;");

                // Sustitución de emojis por iconos FontAwesome en los badges
                let badgeHtml = '';
                if(item.featured) {
                    badgeHtml = '<span class="badge badge-star"><i class="fas fa-fire"></i> MÁS VENDIDO</span>';
                }
                
                let iptvExtraBadge = '';
                if(style === 'iptv' && item.margin !== 'N/A' && !item.featured) {
                    // Nota: 'item.margin' es texto, lo dejamos como está, pero reemplazamos el emoji de fuego en el JS anterior si existía
                    iptvExtraBadge = '<span class="badge badge-iptv" style="font-size:0.6em; margin-left:5px;"><i class="fas fa-fire"></i></span>';
                } else if(style === 'iptv' && item.featured) {
                     // Caso especial si se requiere badge estrella
                     // ya cubierto arriba
                }

                return `
                <article class="card-product ${isIptvSection ? 'iptv-card' : ''} ${item.featured ? 'featured-card' : ''}">
                    <div class="card-header">
                        ${badgeHtml}
                        <div class="product-title">
                            ${item.name}
                            ${iptvExtraBadge}
                        </div>
                        <span class="product-subtitle">${item.sub}</span>
                    </div>
                    <div style="margin-top:auto;">
                        <div class="product-price">${displayFormatter.format(displayPrice)}</div>
                        <button class="btn-add-cart" onclick="addToCart(${itemPayload})">
                            <i class="fas fa-plus-circle"></i> Agregar
                        </button>
                    </div>
                </article>
            `}).join('');
        }
        
        function setIPTVCurrency(currency) {
            currentIPTVCurrency = currency;
            document.getElementById('btn-cop').classList.toggle('active', currency === 'COP');
            document.getElementById('btn-usd').classList.toggle('active', currency === 'USD');
            renderGrid('iptv-grid', INVENTORY.iptv, 'iptv');
        }

        // --- LÓGICA DE COMBOS ---
        let currentComboKey = "god_tier";

        function initCombos() {
            const selectorContainer = document.getElementById('base-selector');
            Object.keys(COMBO_SYSTEM).forEach(key => {
                const btn = document.createElement('button');
                btn.className = `selector-btn ${key === currentComboKey ? 'active' : ''}`;
                btn.textContent = COMBO_SYSTEM[key].label;
                btn.onclick = () => switchComboBase(key);
                selectorContainer.appendChild(btn);
            });
            updateComboUI();
        }

        function switchComboBase(key) {
            currentComboKey = key;
            document.querySelectorAll('input[name="opt"]').forEach(cb => cb.checked = false);
            document.querySelectorAll('.selector-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent === COMBO_SYSTEM[key].label);
            });
            updateComboUI();
        }

        function updateComboUI() {
            const config = COMBO_SYSTEM[currentComboKey];
            const sizeContainer = document.getElementById('size-options');
            const optContainer = document.getElementById('platform-options');
            
            const existingTier = document.querySelector('input[name="tier"]:checked');
            const selectedIdx = existingTier ? existingTier.value : 0;

            sizeContainer.innerHTML = config.tiers.map((tier, idx) => `
                <label>
                    <input type="radio" name="tier" value="${idx}" class="input-hidden" ${idx == selectedIdx ? 'checked' : ''} onchange="calcCombo()">
                    <div class="tier-row">
                        <span style="font-weight:600;">${tier.label}</span>
                        <span style="font-family:monospace; font-weight:700;">${FORMATTER_COP.format(tier.retail)}</span>
                    </div>
                </label>
            `).join('');

            const currentlyChecked = Array.from(document.querySelectorAll('input[name="opt"]:checked')).map(cb => cb.value);

            optContainer.innerHTML = config.options.map(opt => `
                <label>
                    <input type="checkbox" name="opt" value="${opt}" class="input-hidden" ${currentlyChecked.includes(opt) ? 'checked' : ''} onchange="calcCombo()">
                    <span class="check-btn">${opt}</span>
                </label>
            `).join('');

            document.getElementById('base-includes').textContent = config.includes;
            document.getElementById('combo-note').textContent = config.note;

            calcCombo();
        }

        function calcCombo() {
            const config = COMBO_SYSTEM[currentComboKey];
            const tierInput = document.querySelector('input[name="tier"]:checked');
            if(!tierInput) return;
            
            const tierIdx = tierInput.value;
            const tier = config.tiers[tierIdx];
            
            let baseCount = 1;
            if (currentComboKey === 'god_tier') baseCount = 2;
            if (currentComboKey === 'flex_mix') baseCount = 0;

            const maxAdicionales = tier.k - baseCount;
            const checkboxes = document.querySelectorAll('input[name="opt"]');
            const checked = Array.from(checkboxes).filter(c => c.checked);
            
            document.getElementById('count-current').textContent = checked.length;
            document.getElementById('count-max').textContent = maxAdicionales;
            document.getElementById('total-price').textContent = FORMATTER_COP.format(tier.retail);
            
            const btnAdd = document.getElementById('btn-add-combo');
            const isFull = checked.length === maxAdicionales;
            
            checkboxes.forEach(cb => {
                if(!cb.checked) {
                    cb.disabled = checked.length >= maxAdicionales;
                } else {
                    cb.disabled = false;
                }
            });
        }

        window.addEventListener('DOMContentLoaded', () => {
            try {
                renderGrid('premium-grid', INVENTORY.premium);
                renderGrid('standard-grid', INVENTORY.standard);
                renderGrid('iptv-grid', INVENTORY.iptv, 'iptv');
                renderGrid('tools-grid', INVENTORY.tools);
                initCombos();
            } catch (e) {
                console.error("Critical Init Error:", e);
                showToast("Error crítico al cargar la tienda", "error");
            }
        });

    </script>
</body>
</html>
